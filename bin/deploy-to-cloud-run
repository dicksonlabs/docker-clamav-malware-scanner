#!/usr/bin/env bash

fail() {
    echo "$@" 1>&2
    exit 1
}

suffix="$1"
version="$2"
test -n "$version" || fail "Usage: $0 PROJECT-SUFFIX BUILD-VERSION"

region="us-central1"
project_id="malware-scanner-svc-$suffix"
remote_tag="$version"
remote_image="$region-docker.pkg.dev/$project_id/malware-scanner-service/malware-scanner-service"
service_account_name="malware-scanner-service"
service_name="malware-scanner-service"

# FIXME: tune --memory and --cpu.
cd cloudrun-malware-scanner \
    && gcloud auth configure-docker "$region-docker.pkg.dev" \
    && docker build --tag malware-scanner-service:deploy . \
    && docker tag malware-scanner-service:deploy "$remote_image:$remote_tag" \
    && docker push "$remote_image:$remote_tag" \
    && gcloud run deploy malware-scanner-service \
	      --memory 4Gi \
	      --platform managed \
	      --project "$project_id" \
	      --no-allow-unauthenticated \
	      --no-cpu-throttling \
	      --image "$remote_image:$remote_tag" \
	      --region "$region" \
	      --service-account="$service_account_name" \
	      --use-http2
