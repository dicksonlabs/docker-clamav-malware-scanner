#!/usr/bin/env bash

fail() {
    echo "$@" 1>&2
    exit 1
}

suffix="$1"
billing_account_id="$2"
test -n "$billing_account_id" || fail "Usage: $0 PROJECT-SUFFIX BILLING-ACCOUNT-ID

PROJECT-SUFFIX - A short unique ID to add to the end of the Google Cloud project ID. E.g., gmd30
BILLING-ACCOUNT-ID - See \`gcloud alpha billing accounts list\`
"

project_id="malware-scanner-svc-$suffix"
service_account_name="malware-scanner-service"
service_account_principal="$service_account_name@$project_id.iam.gserviceaccount.com"
credentials_file="gcloud-credentials-$project_id-$service_account_name.json"
region="us-central1"

run_with_retry() {
    command="$@"

    $command
    while [ $? != 0 ]
    do
	echo "Error running $command"
	echo "Will try again..."
	sleep 10
	$command
    done

    return 0
}

gcloud auth configure-docker us-central1-docker.pkg.dev \
    && gcloud projects create "$project_id" \
    && gcloud alpha billing projects link "$project_id" --billing-account "$billing_account_id" \
    && gcloud --project "$project_id" iam service-accounts create "$service_account_name" \
    && gcloud --project "$project_id" services enable run.googleapis.com \
    && gcloud --project "$project_id" services enable artifactregistry.googleapis.com \
    && run_with_retry gcloud --project "$project_id" artifacts repositories create malware-scanner-service --repository-format Docker --location us-central1 \
    && ./bin/deploy-to-cloud-run "$suffix" "v1.initial.deployment" \
    && gcloud init \
    && echo -e "\nSuccessfully created https://console.cloud.google.com/home/dashboard?project=$project_id"
